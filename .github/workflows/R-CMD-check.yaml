# R CMD check - CRAN Ready
# Replicates winbuilder conditions (Windows R-devel + --as-cran)
# Detects issues before CRAN submission

name: R-CMD-check-CRAN-ready

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions: read-all

jobs:
  # Job 1: Multi-platform standard check
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    strategy:
      fail-fast: false
      matrix:
        config:
          # Windows (critical - where winbuilder failed)
          - {os: windows-latest, r: 'release'}
          - {os: windows-latest, r: 'devel'}

          # Ubuntu (standard coverage)
          - {os: ubuntu-latest, r: 'devel'}
          - {os: ubuntu-latest, r: 'release'}
          - {os: ubuntu-latest, r: 'oldrel-1'}

          # macOS (recommended for CRAN)
          - {os: macos-latest, r: 'release'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      _R_CHECK_FORCE_SUGGESTS_: false
      NOT_CRAN: true

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'

  # Job 2: CRAN strict check (replicates winbuilder exactly)
  CRAN-check:
    runs-on: ${{ matrix.config.os }}
    name: CRAN-${{ matrix.config.os }} (${{ matrix.config.r }})
    needs: R-CMD-check

    strategy:
      fail-fast: false
      matrix:
        config:
          # Windows R-devel: exactly like winbuilder
          - {os: windows-latest, r: 'devel'}
          # Ubuntu release: standard CRAN check
          - {os: ubuntu-latest, r: 'release'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      _R_CHECK_FORCE_SUGGESTS_: false
      _R_CHECK_CRAN_INCOMING_: true
      _R_CHECK_CRAN_INCOMING_REMOTE_: true
      _R_CHECK_EXAMPLE_TIMING_THRESHOLD_: 5
      NOT_CRAN: false

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - name: Check URLs in documentation
        run: |
          message("Checking URLs in Rd files...")
          rd_files <- list.files("man", pattern = "\\.Rd$", full.names = TRUE)
          if (length(rd_files) > 0) {
            for (f in rd_files) {
              tryCatch({
                tools::checkRd(f)
              }, error = function(e) {
                message("Warning in ", basename(f), ": ", e$message)
              })
            }
          }
          message("URL check complete")
        shell: Rscript {0}

      - name: R CMD check (--as-cran)
        run: |
          options(crayon.enabled = TRUE)
          rcmdcheck::rcmdcheck(
            args = c("--no-manual", "--as-cran"),
            error_on = "warning",
            check_dir = "check"
          )
        shell: Rscript {0}

      - name: Check example timings
        if: always()
        run: |
          timing_file <- list.files("check", pattern = "timings",
                                     recursive = TRUE, full.names = TRUE)
          if (length(timing_file) > 0) {
            timings <- read.delim(timing_file[1])
            cat("Example timings:\n")
            print(timings)
            slow <- timings[timings$elapsed > 5, ]
            if (nrow(slow) > 0) {
              cat("\nERROR: Examples exceeding 5s threshold:\n")
              print(slow)
              stop("Slow examples detected - CRAN will flag this")
            } else {
              cat("\nAll examples under 5s threshold\n")
            }
          } else {
            cat("No timing file found\n")
          }
        shell: Rscript {0}

      - name: Show testthat output
        if: always()
        run: |
          find check -name 'testthat.Rout*' -exec cat '{}' \; || true
        shell: bash

      - name: Upload check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.config.os }}-r${{ matrix.config.r }}-results
          path: check
